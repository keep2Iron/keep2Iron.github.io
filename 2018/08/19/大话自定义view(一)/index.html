<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 大话自定义view(1) · Keep2iron's Road to development</title><meta name="description" content="大话自定义view(1) - Keep2iron"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://keep2iron.github.io/atom.xml" title="Keep2iron's Road to development"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/Keep2iron" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/keep2iron" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">大话自定义view(1)</h1><div class="post-info">Aug 19, 2018</div><div class="post-content"><h5>出师不利</h5>

<p>小艾从新兵训练营毕业，在训练营中学习不少编程方面的知识，学着编写了不少Android方面的小程序，他踌躇满志一心想要报考<em>Android调查兵团</em>。终于当投递了无数次申请了之后，调查兵团准许了小艾的申请，并给与了他一次面试的机会。</p>
<p>到了要进行面试的日子，考官发放了一个题目，上面写道：“<strong>请编写一个如下图的自定义控件</strong>”</p>
<p><img src="https://i.imgur.com/X1ZyPpl.png" alt="pic1"></p>
<a id="more"></a>
<p>小艾心想糟了，身上这一身本事都是CV老师教的(PS:老夫敲代码就是一梭子.png)，自己写这自定义控件还真的是不太行阿~。小艾心灰意冷的答完了题目，垂头丧一些气的回到了自己的房间，痛定思痛心想：这自定义控件劳资一定要攻破它，说着小艾就打开了aoogle搜索了一下这自定义控件的一些知识。</p>
<p></p><h5>奇怪的Constructor</h5>小艾：哦，这第一步原来是要继承一个View或者一个ViewGroup​，我这个自定义控件是一个圆形进度条，那么我就起名叫<strong>CircleProgressView</strong>吧！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleProgress</span> <span class="keyword">extends</span> <span class="title">View</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">CircleProgress</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//@Nullable是android扩展包的注解，标识这个变量是可以为null的</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">CircleProgress</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">CircleProgress</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p>
<p>可是这自定义View为啥要重写了这三个方法呢？小艾这是产生了一个疑惑，不过正好今天是一个星期六，大表哥正好来小艾家玩，心里正犯嘀咕。大表哥看了一眼代码，瞅了一眼犯嘀咕的小艾。</p>
<p>大表哥：”小艾呀，我知道你心中为啥这么困惑。首先第一个方法<em>CircleProgress(Context)</em>是保证了我们能够<strong>直接创建一个自定义控件</strong>因此才有了第一个构造方法。第二个方法的带了一个<strong>AttributeSet</strong>，这个方法是为了Android中使用<strong>Pull解析</strong>xml时，解析之后的属性便全部都放入了这个对象中，简单点说就是为了<strong>提供给xml解析时调用</strong>。第三个方法嘛，说来安卓真的是为我们开发者操碎了心，第三个参数用于解析主题文件时能够产生不同属性值，因此才有了这第三个参数。”</p>
<blockquote>
<p>在第一种new出来的生成方式的时候，会调用一个参数的构造方法。</p>
</blockquote>
<blockquote>
<p>第二种使用xml声明的方式则会调用两个参数的构造方法</p>
</blockquote>
<blockquote>
<p>第三个参数的意义在于在当前主题中包含了style资源的一个属性值，适用于对于当前view的一个默认style。 需要特别指出的是三个参数的构造方法系统是不进行调用的，需要我们这里显式的进行调用，比如我们的Button通过调用，并传递了com.android.internal.R.attr.buttonStyle，而在4.4的主题文件是holo风格，然后定义了button的默认的几个属性</p>
</blockquote>
<p>以Button为例下面，是Button的构造方法以及style文件中的声明。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Button</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Button</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>(context, attrs, com.android.internal.R.attr.buttonStyle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Button</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Theme.DeviceDefault"</span> <span class="attr">parent</span>=<span class="string">"Theme.Holo"</span> &gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">	...</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"buttonStyle"</span>&gt;</span>@android:style/Widget.DeviceDefault.Button<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined">	....</span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.DeviceDefault.Button"</span> <span class="attr">parent</span>=<span class="string">"Widget.Holo.Button"</span> &gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Widget.Holo.Button"</span> <span class="attr">parent</span>=<span class="string">"Widget.Button"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:background"</span>&gt;</span>@android:drawable/btn_default_holo_dark<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:textAppearance"</span>&gt;</span>?android:attr/textAppearanceMedium<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:textColor"</span>&gt;</span>@android:color/primary_text_holo_dark<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:minHeight"</span>&gt;</span>48dip<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:minWidth"</span>&gt;</span>64dip<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p></p><h5>懵逼的onMeasure</h5>大表哥：言归正传，以上就是构造函数的一些意义啦，这些东西多结合实战才会有进步~！当然了理解constructor的过程还是第一步，后面还有你好看的呢~！来看一下这个函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">	<span class="comment">//获取测量的宽度和高度</span></span><br><span class="line">	<span class="keyword">int</span> widthSize = getMeasureSize(widthMeasureSpec);</span><br><span class="line">	<span class="keyword">int</span> heightSize = getMeasureSize(heightMeasureSpec);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> size = widthSize &gt; heightSize ? heightSize : widthSize;</span><br><span class="line">	<span class="comment">//必须调用这个方法，进行设置大小</span></span><br><span class="line">	setMeasuredDimension(size,size);</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMeasureSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> mode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">	<span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span>(mode)&#123;</span><br><span class="line">		<span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">		<span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">			size = MeasureSpec.getSize(measureSpec);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">			size = CommonUtil.dp2px(getContext(),<span class="number">50</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//决定了我们自己的控件相对与父控件的位置</span></span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p>
<p>小艾：哇，这个函数干啥玩意的咋越看越懵逼呢！！<br>大表哥：哈哈，懵逼吧~，不过我先跟你阐述几个概念，这几个概念你心里有个数，后面不会再查文档就行了。</p>
<p><strong>EXACTLY</strong></p>
<p>表示父视图希望子视图的大小应该是由specSize的值来决定的，系统默认会按照这个规则来设置子视图的大小，开发人员当然也可以按照自己的意愿设置成任意的大小。</p>
<p><strong>AT_MOST</strong></p>
<p>表示子视图最多只能是specSize中指定的大小，开发人员应该尽可能小得去设置这个视图，并且保证不会超过specSize。系统默认会按照这个规则来设置子视图的大小，开发人员当然也可以按照自己的意愿设置成任意的大小。</p>
<p><strong>UNSPECIFIED</strong></p>
<p>表示开发人员可以将视图按照自己的意愿设置成任意的大小，没有任何限制。这种情况比较少见，不太会用到。</p>
<blockquote>
<p>上面的一些表述参考了郭霖的<a href="http://blog.csdn.net/guolin_blog/article/details/16330267" target="_blank" rel="noopener">博客</a></p>
</blockquote>
<p></p><h5>一些基本的操作</h5><br>大表哥：今天主要是画这个进度是吧，既然要画东西（Canvas），起码我们是必须要有一个笔的，在Android中有个类叫<strong>Paint</strong>，你去官方文档看下它这个相关的api做一些demo基本上就能够上手啦~！当然我们这里再来说说获取了画笔之后，一些关于自定义控件的基本操作。有几点是要确定的<br><strong>1.绘制区域的大小（主要跟控件的大小有关）</strong><br>小艾：立方懵逼.png…….<br>大表哥：一般我觉得写自定义控件来说，获取他的大小基本上必不可少，那么在什么函数获取大小比较合适呢？我个人认为在onSizeChanged(int w, int h, int oldw, int oldh) 这个方法中进行赋值大小比较合适。虽然onDraw可以获取但是onDraw会可能会调用多次，书写一些初始化操作就不太合适了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSizeChanged</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> oldw, <span class="keyword">int</span> oldh)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh);</span><br><span class="line">	<span class="comment">//初始化画笔的宽度</span></span><br><span class="line">	<span class="keyword">int</span> strokeSize = (<span class="keyword">int</span>) (getMeasuredWidth() / <span class="number">2</span> * <span class="number">0.3f</span>);</span><br><span class="line">	<span class="keyword">int</span> size = <span class="number">10</span> + strokeSize;</span><br><span class="line">	<span class="comment">//初始化绘制区域</span></span><br><span class="line">	mDrawRect = <span class="keyword">new</span> RectF(getPaddingLeft() + size,getPaddingTop() + size,getWidth() -getPaddingLeft() - size,getHeight() - getPaddingBottom() - size);</span><br><span class="line">	mPaint.setStrokeWidth(strokeSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p>
<p></p><h5>干活啦！气氛搞起来~</h5><br>大表哥：终于到了你应该最感兴趣的代码了，这里来说说绘制的流程<p></p>
<ol>
<li><p><strong>canvas.save()</strong>这里主要为了保存画布的状态，因为后面可能还需要针对画布进行旋转、平移、缩放等等操作。</p>
</li>
<li><p><strong>canvas.ratate/translate/scale</strong>这里是针对画布进行平移缩放，当然了画布的坐标系也会同步修改。</p>
</li>
<li><strong>canvas.draw</strong>这里就是干活的地方，发挥你灵魂画师的基本功力，在这里可以为所欲为的画你想画的东西。</li>
<li><strong>canvas.restore()</strong>切记如果你之前<strong>save过画布之后，一定要restore！！</strong>,你也不想后面画着其他图形的时候犯嘀咕，咦？我这矩形咋飞上了天？？明明就是居中的阿~~。<strong>主要就是恢复save时canvas的坐标系</strong>。</li>
</ol>
<p>下面就是一个代码实例，小艾你就跟着多练习啦，下午有个大保健等着我，溜了溜了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//保存画布的当前状态</span></span><br><span class="line">	canvas.save();</span><br><span class="line">	<span class="comment">//旋转画布逆时针90°，那么坐标系就发生了旋转了。</span></span><br><span class="line">	canvas.rotate(-<span class="number">90</span>,mDrawRect.centerX(),mDrawRect.centerY());</span><br><span class="line">	<span class="comment">//设置背景圆的颜色</span></span><br><span class="line">	mPaint.setColor(mDefColor);</span><br><span class="line">	canvas.drawCircle(mDrawRect.centerX(),mDrawRect.centerY(),mDrawRect.width() / <span class="number">2</span>,mPaint);</span><br><span class="line">	<span class="comment">//设置弧线的颜色</span></span><br><span class="line">	mPaint.setColor(mColor);</span><br><span class="line">	canvas.drawArc(mDrawRect,<span class="number">0</span>,mProgress * <span class="number">360</span>,<span class="keyword">false</span>,mPaint);</span><br><span class="line">	<span class="comment">//重新恢复画布</span></span><br><span class="line">	canvas.restore();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>小艾：留下了没技术的泪水.png~~~</p>
<p>自定义控件系列还在持续连载中!!!!coming soon</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/11/03/React-Native跨平台技术选型/" class="prev">PREV</a><a href="/2018/08/19/ReactNative通信实现原理/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'keep2iron';
var disqus_identifier = '2018/08/19/大话自定义view(一)/';
var disqus_title = '大话自定义view(1)';
var disqus_url = 'https://keep2iron.github.io/2018/08/19/大话自定义view(一)/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//keep2iron.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2019 <a href="https://keep2iron.github.io">Keep2iron</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>